     1                                  bits 32 
     2                                  global start        
     3                                  
     4                                  ;A file name is given in the data segment. This contains digits separated by space (the digits are from the set of 16 base digits separated).
     5                                  ;Print each digit read from the file and the number of 0 bits in the binary representation of it.
     6                                  
     7                                  extern exit, fopen, printf, fclose, fscanf               
     8                                  import exit msvcrt.dll    
     9                                  import fopen msvcrt.dll
    10                                  import printf msvcrt.dll
    11                                  import fclose msvcrt.dll
    12                                  import fscanf msvcrt.dll
    13                                  
    14                                  
    15                                  segment data use32 class=data
    16 00000000 696E7075742D657832-         file db "input-ex22.txt", 0
    16 00000009 322E74787400       
    17 0000000F 7200                        read_mode db "r", 0
    18 00000011 <res 00000004>              descriptor resd 1
    19 00000015 <res 00000004>              x resd 1
    20 00000019 257800                      scanf_format db "%x", 0
    21 0000001C 2578202D2025642C00          printf_format db "%x - %d,", 0
    22                                  
    23                                  segment code use32 class=code
    24                                      start:
    25                                          
    26                                          ;fopen(file, "r")
    27 00000000 68[0F000000]                    push dword read_mode
    28 00000005 68[00000000]                    push dword file
    29 0000000A FF15[00000000]                  call [fopen]
    30 00000010 83C408                          add esp, 4 * 2
    31 00000013 A3[11000000]                    mov [descriptor], eax
    32                                  
    33                                          ;while(fscanf(descriptor, "%x", &number) != EOF)
    34                                          while_reading:
    35                                              ;fscanf(descriptor, "%x", &number)
    36 00000018 68[15000000]                        push dword x
    37 0000001D 68[19000000]                        push dword scanf_format
    38 00000022 FF35[11000000]                      push dword [descriptor]
    39 00000028 FF15[00000000]                      call [fscanf]
    40 0000002E 83C40C                              add esp, 4 * 3
    41                                  
    42                                              ;if(fscanf(descriptor, "%x", &number) == EOF)
    43 00000031 83F8FF                              cmp eax, -1
    44 00000034 7432                                je end_reading
    45                                              
    46                                              ;counting the bits from x
    47 00000036 B904000000                          mov ecx, 4      ;4 executions of the loop
    48 0000003B BB00000000                          mov ebx, 0      ;counter
    49 00000040 A1[15000000]                        mov eax, [x]
    50                                              while_eax:
    51 00000045 A901000000                              test eax, 1     ;if the last bit is 1
    52 0000004A 7501                                    jnz bit_is_1
    53                                  
    54                                                  ;if the last bit is 0
    55 0000004C 43                                      inc ebx
    56                                  
    57                                                  bit_is_1:
    58 0000004D D1E8                                    shr eax, 1      ;shift right
    59                                  
    60 0000004F E2F4                                    loop while_eax
    61                                              
    62                                  
    63                                              ;printf(printf_format, x, ecx)
    64 00000051 53                                  push dword ebx
    65 00000052 FF35[15000000]                      push dword [x]
    66 00000058 68[1C000000]                        push dword printf_format
    67 0000005D FF15[00000000]                      call [printf]
    68 00000063 83C40C                              add esp, 4 * 3
    69                                  
    70 00000066 EBB0                                jmp while_reading
    71                                  
    72                                          end_reading:
    73                                  
    74                                          ;fclose(descriptor)
    75 00000068 FF35[11000000]                  push dword [descriptor]
    76 0000006E FF15[00000000]                  call [fclose]
    77 00000074 83C404                          add esp, 4
    78                                  
    79                                  
    80 00000077 6A00                            push    dword 0      
    81 00000079 FF15[00000000]                  call    [exit]       
